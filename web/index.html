<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/style.css">
  <title>Document</title>
  
</head>
<body>
  <div id="loading" style="display:none;">
    <div class="loading-overlay" ></div>
    <div class="loading-spinner">
      <i></i>
      <span>Loading...</span>
    </div>
  </div>
  <div class="file-box">
    <div for="file" id="file_label">
      <button id="input_label_btn">选择文件</button>
      <input type="file" id="file" multiple style="display: none;">
    </div>
    
    <button id="file_btn">上传</button>
  </div>
  <ul id="file_list">
    <span class="temp">列表为空</span>
  </ul>
</body>
<script type="module">

  import { cutFile } from './js/cutFile.js'

  document.querySelector('#file_btn').addEventListener('click', uploadFile);

  const fileInput = document.querySelector('#file');

  const fileList = document.querySelector('#file_list');

  const inputLabelBtn = document.querySelector('#input_label_btn');

  inputLabelBtn.addEventListener('click', () => {

    fileInput.click();

  });

  fileInput.addEventListener('change', () => {
    // 清空文件列表
    fileList.innerHTML = '';
    
    // 获取选中的文件
    const files = fileInput.files;
    
    // 遍历文件并展示文件名和大小
    for (let i = 0; i < files.length; i++) {

      const file = files[i];

      const listItem = document.createElement('li');

      listItem.innerHTML = `<span class="pross"></span><span>${file.name}</span><span>${(file.size / 1024).toFixed(2)}KB</span>`;

      fileList.appendChild(listItem);

    }

  });

  async function getUploadedChunks(filename) {

    const res = await fetch(`/file/getUploadedChunks?filename=${filename}`);

    return res.json()
  }

  async function uploadFile() {

    const files = fileInput.files;

    if (!files.length) {

      showLoading('请选择一个文件', 2000)

      return
    };

    for (let fileIndex = 0; fileIndex < files.length; fileIndex++) {
      const file = files[fileIndex];
      
      const uploadedChunks = await getUploadedChunks(file.name);

      console.log(file.name, uploadedChunks)
  
      const needUploadChunks = [];
  
      cutFile(file, uploadedChunks, ({chunkIndex, chunkHash, chunkBlob, isUploaded}, isMerge) => {
  
        needUploadChunks.push({chunkIndex, chunkHash, chunkBlob, isUploaded});
  
        uploadChunk(chunkIndex, chunkHash, chunkBlob, file.name, isMerge, needUploadChunks, fileIndex)
      })
    
    }

  }

  function calculateUploadedPercentage(chunks) {
    // 计算已上传的数据数量
    const uploadedCount = chunks.filter(chunk => chunk.isUploaded).length;
    
    // 计算总数据数量
    const totalCount = chunks.length;

    // 计算已上传数据的占比
    const uploadedPercentage = (uploadedCount / totalCount) * 100;

    return uploadedPercentage.toFixed(2); // 保留两位小数
  }

  async function uploadChunk(chunkIndex, chunkHash, chunkBlob, filename, isMerge, chunks, fileIndex) {

    const formData = new FormData();
    formData.append('chunkIndex', chunkIndex);
    formData.append('chunkHash', chunkHash);
    formData.append('filename', filename);
    formData.append('chunkBlob', chunkBlob);

    const res = await fetch('/file/upload', {
      method: 'POST',
      body: formData
    });

    if (!res.ok) {
      console.log('分片上传失败了')
      return;
    };

    const index = chunks.findIndex((item) => chunkIndex === item.chunkIndex);

    chunks[index].isUploaded = true;

    const percentage = calculateUploadedPercentage(chunks);

    const prossList = document.querySelectorAll('#file_list li .pross');

    prossList[fileIndex].style.width = `${percentage}%`;

    console.log('isMerge:::', isMerge)

    // if (!isMerge) return;

    const isAllUploaded = chunks.every(({isUploaded}) => isUploaded);

    console.log('isAllUploaded:::', isAllUploaded)

    if (isAllUploaded) mergeChunks(filename)
  };

  async function mergeChunks(filename) {

    const res = await fetch('/file/merge', {
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify({filename})
    });

    if (!res.ok) {
      showLoading('文件合并失败了', 2000)
      return;
    };

  }
</script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="./js/loading.js"></script>
</html>